; ============================================
; Supervisord Configuration
; ============================================
; Analogi: Supervisor = Manager yang ngawasin staff
; - Nginx (receptionist)
; - PHP-FPM (koki)
; - Queue Worker (staff delivery)
; Kalau ada yang mati, supervisor restart otomatis
; ============================================

[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid

; Nginx - Web server
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/nginx.log
stderr_logfile=/var/log/supervisor/nginx_error.log
priority=10

; PHP-FPM - PHP processor
[program:php-fpm]
command=/usr/local/sbin/php-fpm -F
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/php-fpm.log
stderr_logfile=/var/log/supervisor/php-fpm_error.log
priority=20

; Laravel Queue Worker - High Priority (webhooks)
[program:laravel-queue-webhooks]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/html/artisan queue:work database --queue=webhooks --tries=3 --timeout=60 --sleep=3
autostart=true
autorestart=true
numprocs=2
user=www-data
stdout_logfile=/var/log/supervisor/queue-webhooks.log
stderr_logfile=/var/log/supervisor/queue-webhooks_error.log
stopwaitsecs=60
priority=30

; Laravel Queue Worker - Default & Emails
[program:laravel-queue-default]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/html/artisan queue:work database --queue=default,emails --tries=3 --timeout=120 --sleep=5
autostart=true
autorestart=true
numprocs=1
user=www-data
stdout_logfile=/var/log/supervisor/queue-default.log
stderr_logfile=/var/log/supervisor/queue-default_error.log
stopwaitsecs=120
priority=40

; Laravel Scheduler (untuk cronjob)
[program:laravel-scheduler]
command=/bin/sh -c "while [ true ]; do php /var/www/html/artisan schedule:run --verbose --no-interaction & sleep 60; done"
autostart=true
autorestart=true
user=www-data
stdout_logfile=/var/log/supervisor/scheduler.log
stderr_logfile=/var/log/supervisor/scheduler_error.log
priority=50
