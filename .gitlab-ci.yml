# =====================================================
# GitLab CI/CD Pipeline - Laravel 12 Payment Gateway
# =====================================================
# Pipeline ini akan:
# 1. TEST: Menjalankan 52 automated tests
# 2. BUILD: Build Docker image untuk deployment
# 3. DEPLOY: Deploy ke Render.com (production, gratis!)

stages:
  - test
  - build
  - docs

# Variables global
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  
  # Laravel Testing Environment
  APP_ENV: testing
  DB_CONNECTION: pgsql
  DB_HOST: postgres
  DB_PORT: 5432
  DB_DATABASE: testing
  DB_USERNAME: postgres
  DB_PASSWORD: secret
  
  # JWT Configuration (untuk auth tests)
  JWT_SECRET: "6zGKX9TxWk7t6VRBlHoQ8m7X8Q556epjmH23xn6oghPSOHmobIi3UWFYcE2AqDG4"
  JWT_TTL: 60
  JWT_REFRESH_TTL: 20160
  
  # Midtrans Configuration (untuk order tests)
  # IMPORTANT: Set these in GitLab CI/CD Variables (Settings -> CI/CD -> Variables)
  # MIDTRANS_CLIENT_KEY: Set via GitLab Variables (masked)
  # MIDTRANS_SERVER_KEY: Set via GitLab Variables (masked)
  # MIDTRANS_IS_PRODUCTION: false
  # MIDTRANS_IS_SANITIZED: true
  # MIDTRANS_IS_3DS: true

# =====================================================
# STAGE 1: TESTING
# =====================================================

# Job 1.1: Code Style Check dengan Laravel Pint
pint:
  stage: test
  image: php:8.4-cli
  
  cache:
    key: ${CI_COMMIT_REF_SLUG}-pint
    paths:
      - vendor/
  
  before_script:
    - apt-get update -qq && apt-get install -y -qq git unzip
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer install --prefer-dist --no-progress --no-interaction
  
  script:
    - ./vendor/bin/pint --test
  
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_MERGE_REQUEST_ID'
    - when: always

# Job 1.2: Run All Tests (52 tests dengan Pest)
test:
  stage: test
  image: php:8.4-cli
  
  # PostgreSQL & Redis sebagai service dependencies
  services:
    - postgres:16-alpine
    - redis:7-alpine
  
  variables:
    POSTGRES_DB: testing
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: secret
    REDIS_HOST: redis
  
  cache:
    key: ${CI_COMMIT_REF_SLUG}-test
    paths:
      - vendor/
  
  before_script:
    # Install system dependencies
    - apt-get update -qq && apt-get install -y -qq 
        git 
        libpq-dev 
        libzip-dev 
        unzip
    
    # Install PHP extensions (PostgreSQL, Redis, Zip)
    - docker-php-ext-install pdo pdo_pgsql zip
    - pecl install redis
    - docker-php-ext-enable redis
    
    # Install Composer
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    
    # Install dependencies
    - composer install --prefer-dist --no-ansi --no-interaction --no-progress
    
    # Setup Laravel environment
    - cp .env.example .env
    - php artisan key:generate
    - php artisan config:clear
  
  script:
    # Run migrations
    - php artisan migrate --force --no-interaction
    
    # Run all 52 tests
    - php artisan test --parallel
  
  # Simpan test reports sebagai artifacts
  artifacts:
    when: always
    reports:
      junit: tests/results.xml
    paths:
      - tests/results.xml
    expire_in: 1 week
  
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_MERGE_REQUEST_ID'

# =====================================================
# STAGE 2: BUILD
# =====================================================

# Job 2.1: Build Docker Image
build:
  stage: build
  image: docker:24-dind
  
  services:
    - docker:24-dind
  
  before_script:
    # Login ke GitLab Container Registry
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  
  script:
    # Build dari Dockerfile.dev
    - docker build -f Dockerfile.dev -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker build -f Dockerfile.dev -t $CI_REGISTRY_IMAGE:latest .
    
    # Push ke Container Registry
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# =====================================================
# STAGE 3: DOCS - Deploy API Documentation ke GitLab Pages
# =====================================================

pages:
  stage: docs
  image: php:8.3-cli
  
  before_script:
    # Install dependencies
    - apt-get update && apt-get install -y git zip unzip libzip-dev
    - docker-php-ext-install zip
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  
  script:
    - echo "ðŸ“š Generating API documentation..."
    - composer install --no-dev --no-interaction
    - cp .env.example .env
    - php artisan key:generate
    - mkdir -p storage/api-docs
    - chmod -R 777 storage bootstrap/cache
    - php artisan l5-swagger:generate
    - echo "ðŸ“¦ Preparing documentation for GitLab Pages..."
    - mkdir -p public
    - if [ -d "storage/api-docs" ]; then cp -r storage/api-docs/* public/; fi
    - echo "âœ… Documentation ready at https://saulsanto22.gitlab.io/my-first-pipeline"
  
  artifacts:
    paths:
      - public
    expire_in: 1 week
  
  only:
    - main
